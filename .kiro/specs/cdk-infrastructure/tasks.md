# 実装計画: CDKインフラストラクチャ

## 概要

既存のサーバーレスデイリーチェックインアプリケーションをAWS CDKでIaC化するための実装アプローチです。現在手動でデプロイされているS3、CloudFront、Lambda、DynamoDBリソースをCDKコードで管理可能にします。

## タスク

- [x] 1. CDKプロジェクト構造とコア設定の実装
  - infra_stack.pyの基本構造を作成
  - 必要なCDKライブラリのインポート
  - 環境パラメータとタグ設定の実装
  - _要件: 7.1, 7.2, 7.3_

- [ ]* 1.1 CDK設定のプロパティテストを作成
  - **プロパティ7: 環境設定とタグ付けの正確性**
  - **検証対象: 要件 7.1, 7.2, 7.3, 7.5**

- [ ] 2. DynamoDBテーブルの実装
  - DailyHealthLogテーブルの作成
  - パーティションキー（Date）とソートキー（Period）の設定
  - オンデマンド課金モードとポイントインタイムリカバリの設定
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 2.1 DynamoDBテーブルのプロパティテストを作成
  - **プロパティ5: DynamoDBテーブル設定の正確性**
  - **検証対象: 要件 5.1, 5.2, 5.3, 5.4, 5.5**

- [ ] 3. Lambda関数の実装
  - 既存のlamda/submit_daily_checkin.pyを使用したLambda関数作成
  - Python 3.9ランタイムとタイムアウト設定
  - DynamoDBテーブル名の環境変数設定
  - _要件: 3.1, 3.2, 3.4, 3.5_

- [ ]* 3.1 Lambda関数のプロパティテストを作成
  - **プロパティ3: Lambda関数設定の正確性**
  - **検証対象: 要件 3.1, 3.2, 3.3, 3.4, 3.5**

- [ ] 4. IAM権限の実装
  - Lambda関数用のIAMロール作成
  - DynamoDB書き込み権限とCloudWatchログ権限の設定
  - 最小権限の原則に従った権限設定
  - _要件: 3.3, 6.1, 6.2, 6.3_

- [ ]* 4.1 IAM権限のプロパティテストを作成
  - **プロパティ6: IAMセキュリティ設定の正確性**
  - **検証対象: 要件 6.1, 6.2, 6.3, 6.4**

- [ ] 5. チェックポイント - 基本リソースの動作確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば確認する

- [ ] 6. Lambda Function URLの実装
  - Function URLの作成と設定
  - CORS設定とNONE認証タイプの設定
  - POSTリクエスト受け入れ設定
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ]* 6.1 Function URLのプロパティテストを作成
  - **プロパティ4: Function URL設定の正確性**
  - **検証対象: 要件 4.1, 4.2, 4.3, 4.4**

- [ ] 7. S3バケットの実装
  - 静的ウェブサイトホスティング用S3バケット作成
  - バージョニング有効化とアクセス制御設定
  - CloudFront用のOrigin Access Identity設定
  - _要件: 1.1, 1.3, 1.4_

- [ ]* 7.1 S3バケットのプロパティテストを作成
  - **プロパティ1: S3バケット設定の正確性**
  - **検証対象: 要件 1.1, 1.2, 1.3, 1.4**

- [ ] 8. CloudFrontディストリビューションの実装
  - S3バケットをオリジンとするCloudFrontディストリビューション作成
  - HTTPS強制とキャッシュ設定
  - デフォルトルートオブジェクト（index.html）設定
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ]* 8.1 CloudFrontディストリビューションのプロパティテストを作成
  - **プロパティ2: CloudFrontディストリビューション設定の正確性**
  - **検証対象: 要件 2.1, 2.2, 2.3, 2.4**

- [ ] 9. S3バケットデプロイメント機能の実装
  - 既存のS3/index.htmlファイルをバケットにデプロイする機能
  - BucketDeploymentコンストラクトの使用
  - CloudFrontキャッシュ無効化の設定
  - _要件: 1.2_

- [ ] 10. CDKスタック出力の実装
  - CloudFront URLの出力
  - Lambda Function URLの出力
  - 重要なリソース識別子の出力
  - _要件: 7.5_

- [ ]* 10.1 エンドツーエンド統合テストを作成
  - **プロパティ8: エンドツーエンド統合の正確性**
  - **検証対象: 要件 2.5, 4.5**

- [ ] 11. Lambda関数バージョニングの実装
  - Lambda関数のバージョニング設定
  - ロールバック機能のサポート
  - エイリアス設定（オプション）
  - _要件: 8.3_

- [ ]* 11.1 Lambda関数バージョニングのプロパティテストを作成
  - **プロパティ9: Lambda関数バージョニングの正確性**
  - **検証対象: 要件 8.3**

- [ ] 12. 最終チェックポイント - 全体統合テスト
  - すべてのテストが通ることを確認し、ユーザーに質問があれば確認する

## 注意事項

- `*`マークの付いたタスクはオプションで、より高速なMVPのためにスキップ可能
- 各タスクは特定の要件への追跡可能性のために要件を参照
- チェックポイントは段階的な検証を保証
- プロパティテストは普遍的な正確性プロパティを検証
- ユニットテストは特定の例とエッジケースを検証